<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <body>
        <div class="container">
            <div class="row">
                <div class="col">
                      <h1>Consulta a base de datos</h1>      
                </div>
            </div>
            <div class="row">
                <div class="col-2">
                    <input class="form-control altura" type="text" id="ordenarNomb" placeholder="Buscar Nombre">
                </div>
                <div class="col-3">
                    <input class="form-control altura" type="number" id="ordenarDniTxt" placeholder="filtrar por DNI">
                </div>
                <div class="col-2">
                    <select class="form-control altura" id="orderBy" value="0" placeholder="ordenar por">
                        <option class="form-control altura" value="0">Ordenar por...</option>
                        <option class="form-control altura" value="1">DNI ↑</option>
                        <option class="form-control altura" value="2">DNI ↓</option>
                        <option class="form-control altura" value="3">Id ↑</option>
                        <option class="form-control altura" value="4">Id ↓</option>
                    </select>
                </div>
                <div class="col-2">
                    <select class="form-control altura" id="readByTipo" value="0" placeholder="ordenar por">
                        <option class="form-control altura" value="0">Tipo de usuario</option>
                        <option class="form-control altura" value="1">Administrador</option>
                        <option class="form-control altura" value="2">Usuario</option>
                    </select>
                </div>
                <div class="col-2">
                    <button id="botonModal" type="button" class="btn text-center btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">+</button>
                </div>
                     <!-- The Modal -->
                    <div class="modal fade" data-bs-backdrop="static" id="myModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                            
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Añadir datos</h4>
                                    <button id="closeModal(1)" type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                            
                                <!-- Modal body -->
                                <div class="container"> 
                                    <form id="formAdd">
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Nombre Completo</label>
                                                    <input name="nombreCompleto" type="text" id="nombreCompleto" min="0" max="255" placeholder="" class="form-control">        
                                                </div>
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">DNI</label>
                                                    <input name="dni" type="number" id="dni" min="0" max="11" placeholder="" class="form-control">        
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Email</label>
                                                    <input name="email" type="text" id="email" min="0" max="255" placeholder="" class="form-control">        
                                                </div>
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Contraseña</label>
                                                    <input name="contraseña" type="text" id="contrasenna" min="0" max="255" class="form-control">       
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Tipo de usuario</label>
                                                    <input name="tipoUsuario" type="text" id="tipoUsuario" min="0" max="1" placeholder="" class="form-control">        
                                                </div>    
                                            </div>
                                        </div>
                                    </form>    
                                </div>
    
                                <!-- Modal footer -->
                            <div class="modal-footer">
                                <button id="closeModal2(1)" type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                                <button id="addData" type="button" class="btn btn-primary xd">enviar</button>
                            </div>        
                        </div>
                    </div>      
                </div>    
            </div>
            <div class="row">
                <div class="col">   
                    <table class="table table-bordered table-hover table-striped table-sm">
                        <thead>
                            <tr>
                                <th class='xd'>ID usuarios</th>
                                <th class='xd'>Nombre Completo</th>
                                <th class='xd'>Email</th>
                                <th class='xd'>DNI</th>
                                <th class='xd'>Contraseña</th>
                                <th class='xd'>Tipo de usuario</th>
                                <th class='xd'>Editar</th>
                                <th class='xd'>Eliminar</th>
                            </tr>
                        </thead>
                        <tbody  id="tabla1">
                           
                        </tbody>
                    </table>    
                </div>
                <!--<div class="col-2">-->
                    <!-- The Modal -->
                    <div class="modal fade" data-bs-backdrop="static" id="modalUD">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="formUD">
                                    <!-- Modal Header -->
                                    <div class="modal-header">
                                        <div class="col-5">
                                            <h4 class="modal-title">Editar datos</h4>
                                        </div>
                                        <div class="col-2">
                                            <label>id</label><input type="text" class="form-control" name="idUD" id="idUD" readonly>
                                        </div>
                                        <div class="col-5 text-end">  
                                            <button id="closeModalUD" type="button" onclick="" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                    </div>
                            
                                    <!-- Modal body -->
                                    <div class="container"> 
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Nombre Completo</label>
                                                    <input name="nombreCompletoUD" min="0" max="255" type="text" id="nombreCompletoUD" placeholder=""  class="form-control">        
                                                </div>
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">DNI</label>
                                                    <input name="dniUD" type="number" id="dniUD" min="0" max="11" placeholder="" class="form-control"> 
                                                </div>       
                                            </div>
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Email</label>
                                                    <input name="emailUD" type="text" min="0" max="255" id="emailUD" placeholder="" class="form-control">        
                                                </div>
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Contraseña</label>
                                                    <input name="contrasennaUD" type="text" min="0" max="255" id="contrasennaUD"  class="form-control">       
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">                                        
                                                    <label for="texto de ejemplo" class="form-label">Tipo de usuario</label>
                                                    <input name="tipoUsuarioUD" type="text" min="0" max="1" id="tipoUsuarioUD" placeholder="" class="form-control">        
                                                </div>    
                                            </div>
                                        </div>
                                    </div>
                                </form>  
                                <!-- Modal footer -->
                                <div class="modal-footer">
                                    <button id="closeModalUD2" type="button" class="btn btn-danger"  data-bs-dismiss="modal">Cancelar</button>
                                    <button id="editData" type="button" class="btn btn-primary xd" >enviar</button>
                                    <button id="deleteData" type="button" class="btn btn-danger xd" >eliminar</button>
                                </div>        
                            </div>
                        </div>  
                    </div>
                <!--</div>-->
            </div>
        </div>
    </body>
    </html>
    
    <script>
    
    $(document).ready(function()
    {
        
        async function confirmAdd()
        {
        var datos = $('#formAdd').serializeArray();
        
       // var validcion = await validarDatos(datos) 
        if (validcion == true) 
        {
            console.log("validacion exitosa")
            $.ajax({
                type:"POST",    
                url:"addUsuarios.php",
                data: datos,
                success:function(r){
                    if(r == 1)
                    {
                        alert("agregado con exito");
                        $("#ordenarNomb").val(nombreCompleto.value)
                        cargarTabla();
                        $("#myModal").modal('hide')
                    }else
                    {
                        alert("Fallo");
                    }
                }
            })
        }
        else
        {
            console.log("algo anda mal")
        }  
        }
        $("#addData").on("click", function(){confirmAdd() }) 

        //Función para necesaria solamente para el crud original   
       /* async function validarDatos(datos)
        {
            var valido = true
        
            if(datos[0].value.length == 0 || datos[0].value.length > 255)
            {   
                alert("Nombre no valido")
                //console.log("Nombre completo no valido",datos[0].value.length)
                valido = false
                return valido;
            }
            else
            {
                //console.log("Nombre completo valido",datos[0].value, datos[0].value.length)
                if(datos[1].value < 9999999 || datos[1].value > 100000000)
                { 
                    alert("DNI no valido")
                    //console.log("dni no valido",datos[1].value.length)
                    valido = false
                    return valido;
                }
                else
                {
                    //console.log("dni valido", datos[1].value.length)
                    if(datos[2].value.length == 0 || datos[2].value.length > 255)
                    {
                        alert("Correo eletronico no valido")
                        //console.log("email no valido",datos[2].value.length)
                        valido = false
                        return valido;
                    }
                    else
                    {
                        //console.log("email valido",datos[2].value.length)
                        if(datos[3].value.length == 0 || datos[3].value.length > 255)
                        {
                            alert("Contraseña no valida")
                            //console.log("contraseña no valida",datos[3].value.length)
                            valido = false
                            return valido;
                        }
                        else
                        {
                            //console.log("contraseña valida",datos[3].value.length)
                            if(datos[4].value != "A" && datos[4].value != "U"  || datos[4].value.length == 0 || datos[4].value.length > 1)
                            {
                                alert("Tipo de usuario no valido")
                                //console.log("tipo de usuario no valido",datos[4].value.length)
                                valido = false
                                return valido;
                            }
                            else
                            {
                                x = await validarRepetidos(datos)
                                console.log("Await:", x)
                                if(x == false)
                                {
                                    alert("dni o email ya registrado")
                                    valido = false
                                    return valido;
                                    
                                }
                                else
                                {
                                    return valido;
                                    //console.log("tipo de usuario valida",datos[4].value.length)
                                }
                            }
                        }
                    }
                }
            } 
        }*/
    
        function confirmEdit()
        {
        var editarDatos = $("#formUD").serializeArray();
            //Variable para el crud origina 
            //que se sta usando para el modelo//var datos = [editarDatos[1], editarDatos[2], editarDatos[3], editarDatos[4], editarDatos[5]] 
            
            //if(validarDatos(datos))
           // {
                $.ajax({
                url: "RenameUsuarios.php",
                type: "POST",
                data: editarDatos,
                success: function(r)
                {
                    if (r == 1) 
                        {
    
                        alert("datos modificados con exito")
                        $("#ordenarNomb").val(nombreCompletoUD.value)
                        cargarTabla()
                        $("#modalUD").modal('hide')
    
                        }
                    }
                })
           // }
            //else
            //{
                //console.log("algo anda mal")
           // }
        }
    
        function confirmDelete()
        {
            var eliminarDatos = $("#formUD").serializeArray();
            //console.log("editarDatos: ", eliminarDatos)
            $.ajax({
            url: "DeleteUsuarios.php",
            type: "POST",
            data: eliminarDatos,
            success: function(r){
                if (r == 1) 
                    {
                    
                    alert("datos Eliminados")
                    cargarTabla()
                    $("#modalUD").modal('hide')
                    
                    }
                }
            })
        }
    
        $("#editData").on("click", function(){confirmEdit() }) 
        $("#deleteData").on("click", function(){confirmDelete()}) 
    
        function cargarFormEdit(value)
        {
            $("#editData").show()
            $("#deleteData").hide()
            
            $("#idUD").val(value.id_usuario)
            $("#idUD").attr('placeholder', value.id_usuario) 
            
            $("#nombreCompletoUD").val(value.nombre_completo)
            $("#nombreCompletoUD").attr('placeholder', value.nombre_completo) 
            $("#nombreCompletoUD").attr('readonly', false)
            
            $("#dniUD").val(value.dni)
            $("#dniUD").attr('placeholder', value.dni) 
            $("#dniUD").attr('readonly', false)
            
            $("#emailUD").val(value.email)
            $("#emailUD").attr('placeholder', value.email) 
            $("#emailUD").attr('readonly', false)
            
            $("#contrasennaUD").val(value.contrasenna)
            $("#contrasennaUD").attr('placeholder', value.contrasenna) 
            $("#contrasennaUD").attr('readonly', false)
            
            $("#tipoUsuarioUD").val(value.tipo_usuario)
            $("#tipoUsuarioUD").attr('placeholder', value.tipo_usuario) 
            $("#tipoUsuarioUD").attr('readonly', false)
        }
    
        function cargarFormDelete(value)
        {
            $("#deleteData").show()
            $("#editData").hide()
    
            $("#idUD").val(value.id_usuario)
            $("#idUD").attr('placeholder', value.id_usuario) 
            
            $("#nombreCompletoUD").val(value.nombre_completo)
            $("#nombreCompletoUD").attr('placeholder', value.nombre_completo) 
            $("#nombreCompletoUD").attr('readonly', true)
            
            $("#dniUD").val(value.dni)
            $("#dniUD").attr('placeholder', value.dni) 
            $("#dniUD").attr('readonly', true)
            
            $("#emailUD").val(value.email)
            $("#emailUD").attr('placeholder', value.email) 
            $("#emailUD").attr('readonly', true)
            
            $("#contrasennaUD").val(value.contrasenna)
            $("#contrasennaUD").attr('placeholder', value.contrasenna) 
            $("#contrasennaUD").attr('readonly', true)
            
            $("#tipoUsuarioUD").val(value.tipo_usuario)
            $("#tipoUsuarioUD").attr('placeholder', value.tipo_usuario) 
            $("#tipoUsuarioUD").attr('readonly', true)
    
        }
        //Función para necesaria solamente para el crud original   
        /*async function validarRepetidos(array)
        {   
            var noRepetido = false
    
            var dni = array[1].value
            var email = array[2].value
            console.log("dni y email", dni, email)
            
            var ajax = $.ajax({
                url: "BackendUsuarios.php", //action
                type: "POST", //method
                data: {"funcion": 2, "dni": dni, "email": email},
                success: 
                function(respuesta){
                    let check = true
                    var box = JSON.parse(respuesta)
                }
            })
            await ajax 
            const result = await ajax 
    
            var box = JSON.parse(result)
            
            var dniAjax = box[0].dni
            var emailAjax = box[1].email
    
            if(dniAjax == dni)
            {
                console.log("dni repetido")
                noRepetido = false  
                return noRepetido;
            }
            else
            {   
                if(emailAjax == email)
                {
                    console.log("email repetido")
                    noRepetido = false  
                    return noRepetido;
                }
                else
                {
                    console.log("datos no repetidos")
                    noRepetido = true  
                    return noRepetido;
                }     
            }
        }*/
    
        function cargarTabla()
        {   
            $("#tabla1").empty()
            var dni = $('#ordenarDniTxt').val()
            var opt = $("#orderBy").val()
            var read = $("#readByTipo").val()
            var l = $("#ordenarNomb").val()
            if (l != ""){
                //console.log("if")
                $.ajax({
        
                url: "BackendUsuarios.php", //action
                type: "POST", //method
                data: {"funcion": 0, "letra": l, "opcion": opt, "filtro": read, "dni": dni}, 
                //dataType: "json",
                success: function(respuesta){
                    console.log(respuesta)
                    var box = JSON.parse(respuesta) 
                    console.log("datos cargados:",box)
    
                    $.each(box, function(key, value){
                        //console.log("Respuesta: " + respuesta)
                        //console.log("Key: " , key)
                        //console.log("Value: " , value)
    
                        $("#tabla1").append("<tr id='fila"+key+"'  >"+
                        "<td class='xd'>"+value.id_usuario+"</td>"+
                        "<td class='xd'>"+value.nombre_completo+"</td>"+
                        "<td class='xd'>"+value.email+"</td>"+
                        "<td class='xd'>"+value.dni+"</td>"+
                        "<td class='xd'>"+value.contrasenna+"</td>"+
                        "<td class='xd'>"+value.tipo_usuario+"</td>"+
                        "<td class='xd'>"+"<button class='btn btn-sm btn-secondary text-center'  id='edit"+key+"' data-bs-toggle='modal' data-bs-target='#modalUD' >"+"<img class='iconsize xd' src='../../../../img/IconoLapiz.png'>"+"</button>"+"</td>"+
                        "<td class='xd'>"+"<button class='btn btn-sm btn-danger text-center'  id='delete"+key+"' data-bs-toggle='modal' data-bs-target='#modalUD' >"+"<img class='iconsize xd' src='../../../../img/IconoBasura.png'>"+"</td>"+
                        "</tr>") 
                        
                        $("#edit"+key).on("click", function(){
                            //console.log(value)
                            cargarFormEdit(value)
                        })
    
                        $("#delete"+key).on("click", function(){
                            //console.log(value)
                            cargarFormDelete(value)
                        })
                        
                        key = key + 1
                        
                        })
                    }
                })
            }
        }
    
        $("#orderBy").change(function(){
            cargarTabla();
        })
    
        $("#ordenarNomb").keyup(function(){
            cargarTabla();
        })
    
        $("#ordenarDni").click(function(){
            cargarTabla();
        })
    
        $("#readByTipo").change(function(){
            cargarTabla();
        })
    })
    
    </script>
    <style>
    .sex
    {
        border: solid, red;
    }
    
    .xd
    {
        text-align: center;
    }
    
    .iconsize
    {
        height: 30px;
        width: 30px;
    }
    
    .altura
    {
        height: 40px;
    }
    
    /*oculta las flechas del input Type=number*/
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button 
    {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /*oculta las flechas del input Type=number en firefox*/
    input[type=number] 
    {
      -moz-appearance: textfield;
    }
    
    </style>
</body>
</html>